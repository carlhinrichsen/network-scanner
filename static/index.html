<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Network Scanner</title>
<link rel="icon" type="image/png" href="/static/favicon.png">
<link rel="shortcut icon" href="/static/favicon.png">
<style>
  :root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #22263a; --border: #2e3250;
    --accent: #6c63ff; --accent2: #a78bfa; --green: #34d399; --yellow: #fbbf24;
    --red: #f87171; --text: #e2e8f0; --muted: #8892b0; --font: 'Inter', -apple-system, sans-serif;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: var(--font); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

  /* Auth screen */
  .auth-screen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 200; align-items: center; justify-content: center; flex-direction: column; gap: 8px; }
  .auth-screen.active { display: flex; }
  .auth-box { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 36px 32px; width: 100%; max-width: 400px; }
  .auth-logo { font-size: 22px; font-weight: 800; color: var(--accent2); margin-bottom: 4px; }
  .auth-logo span { color: var(--muted); font-weight: 400; }
  .auth-sub { font-size: 13px; color: var(--muted); margin-bottom: 28px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
  .auth-tab { padding: 8px 20px; cursor: pointer; font-size: 14px; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all .2s; }
  .auth-tab.active { color: var(--accent2); border-bottom-color: var(--accent2); font-weight: 600; }
  .auth-field { margin-bottom: 14px; }
  .auth-field label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
  .auth-field input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text); font-size: 14px; font-family: var(--font); }
  .auth-field input:focus { outline: none; border-color: var(--accent); }
  .auth-btn { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; margin-top: 4px; transition: opacity .2s; }
  .auth-btn:hover { opacity: .85; }
  .auth-error { color: var(--red); font-size: 13px; margin-top: 10px; min-height: 18px; }
  .auth-success { color: var(--green); font-size: 13px; margin-top: 10px; min-height: 18px; }
  .guest-link { text-align: center; margin-top: 16px; font-size: 13px; color: var(--muted); line-height: 1.8; }
  .guest-link a { color: var(--accent2); cursor: pointer; text-decoration: underline; }
  .google-btn { display: flex; align-items: center; justify-content: center; gap: 12px; width: 100%; background: white; color: #333; border: 1px solid #ddd; border-radius: 8px; padding: 12px 20px; font-size: 15px; font-weight: 600; font-family: var(--font); cursor: pointer; text-decoration: none; margin: 20px 0 8px; transition: box-shadow .2s, background .2s; }
  .google-btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.2); background: #f8f8f8; }
  .auth-divider { text-align: center; color: var(--muted); font-size: 12px; margin: 8px 0; }

  /* Header */
  .header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: var(--surface); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-img { height: 28px; width: auto; }
  .logo-text { font-size: 18px; font-weight: 700; color: var(--accent2); letter-spacing: -.5px; }
  .logo-text span { color: var(--muted); font-weight: 400; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .stats-bar { display: flex; gap: 20px; }
  .stat { text-align: center; }
  .stat-value { font-size: 18px; font-weight: 700; color: var(--accent2); }
  .stat-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; }
  .mode-badge { font-size: 11px; padding: 3px 10px; border-radius: 20px; font-weight: 600; }
  .mode-badge.private { background: rgba(52,211,153,.15); color: var(--green); }
  .mode-badge.guest { background: rgba(251,191,36,.15); color: var(--yellow); }
  .user-email { font-size: 12px; color: var(--muted); }
  .header-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all .2s; }
  .header-btn:hover { border-color: var(--accent); color: var(--accent2); }
  .header-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
  .header-btn.primary:hover { opacity: .85; }

  /* Layout */
  .app { display: flex; flex: 1; overflow: hidden; }

  /* Chat panel */
  .chat-panel { width: 400px; min-width: 300px; display: flex; flex-direction: column; border-right: 1px solid var(--border); flex-shrink: 0; }
  .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
  .chat-messages::-webkit-scrollbar { width: 4px; }
  .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .msg { max-width: 90%; }
  .msg.user { align-self: flex-end; }
  .msg.assistant { align-self: flex-start; }
  .msg-bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.5; }
  .msg.user .msg-bubble { background: var(--accent); color: white; border-bottom-right-radius: 4px; }
  .msg.assistant .msg-bubble { background: var(--surface2); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
  .msg-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
  .msg.user .msg-meta { text-align: right; }
  .chat-input-area { padding: 12px; border-top: 1px solid var(--border); background: var(--surface); }
  .mode-tabs { display: flex; gap: 6px; margin-bottom: 10px; }
  .mode-tab { padding: 4px 12px; border-radius: 20px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 12px; cursor: pointer; transition: all .2s; }
  .mode-tab.active { background: var(--accent); border-color: var(--accent); color: white; font-weight: 600; }
  .input-row { display: flex; gap: 8px; }
  .chat-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 14px; color: var(--text); font-size: 14px; resize: none; font-family: var(--font); transition: border-color .2s; }
  .chat-input:focus { outline: none; border-color: var(--accent); }
  .send-btn { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .send-btn:disabled { opacity: .4; cursor: not-allowed; }

  /* Results panel */
  .results-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .results-header { padding: 14px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; background: var(--surface); }
  .results-title { font-size: 15px; font-weight: 600; }
  .results-count { font-size: 13px; color: var(--muted); }
  .results-actions { display: flex; gap: 8px; align-items: center; }
  .action-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 14px; border-radius: 8px; cursor: pointer; font-size: 13px; transition: all .2s; }
  .action-btn:hover { border-color: var(--accent); color: var(--accent2); }
  .action-btn.primary { background: var(--accent); border-color: var(--accent); color: white; }
  .action-btn.primary:hover { opacity: .85; }
  .action-btn:disabled { opacity: .4; cursor: not-allowed; }
  .selected-count { font-size: 12px; color: var(--yellow); display: none; }

  /* Table */
  .table-wrapper { flex: 1; overflow: auto; }
  .table-wrapper::-webkit-scrollbar { width: 6px; height: 6px; }
  .table-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  thead { position: sticky; top: 0; z-index: 2; }
  th { background: var(--surface2); padding: 10px 14px; text-align: left; color: var(--muted); font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: .5px; border-bottom: 1px solid var(--border); white-space: nowrap; }
  th.check-col, td.check-col { width: 36px; padding: 10px 4px 10px 14px; }
  td { padding: 10px 14px; border-bottom: 1px solid var(--border); vertical-align: top; }
  tr:hover td { background: rgba(255,255,255,.02); }
  tr.deselected td { opacity: .3; }
  .row-check { width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer; }
  .score-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .score-high { background: rgba(52,211,153,.15); color: var(--green); }
  .score-mid { background: rgba(251,191,36,.15); color: var(--yellow); }
  .score-low { background: rgba(248,113,113,.15); color: var(--red); }
  .linkedin-link { color: var(--accent2); text-decoration: none; font-size: 12px; }
  .linkedin-link:hover { text-decoration: underline; }
  .enriched-pill { font-size: 10px; background: rgba(107,99,255,.2); color: var(--accent2); padding: 1px 6px; border-radius: 10px; margin-left: 4px; }

  /* Empty & notices */
  .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 12px; padding: 40px; text-align: center; }
  .empty-state .icon { font-size: 48px; opacity: .4; }
  .empty-state h3 { font-size: 18px; color: var(--text); }
  .empty-state p { font-size: 14px; max-width: 300px; line-height: 1.6; }
  .confirm-banner { display: none; background: rgba(251,191,36,.1); border: 1px solid var(--yellow); border-radius: 10px; padding: 12px 16px; margin: 12px 20px; font-size: 13px; }
  .confirm-banner.active { display: flex; align-items: center; gap: 12px; }
  .confirm-banner p { flex: 1; color: var(--yellow); }
  .confirm-banner .confirm-actions { display: flex; gap: 8px; }
  .preview-notice { padding: 8px 20px; background: rgba(107,99,255,.1); border-bottom: 1px solid var(--border); font-size: 12px; color: var(--accent2); display: none; }
  .guest-notice { padding: 8px 20px; background: rgba(251,191,36,.08); border-bottom: 1px solid rgba(251,191,36,.3); font-size: 12px; color: var(--yellow); display: none; }

  /* ICP cards */
  .icp-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; padding: 20px; overflow-y: auto; }
  .icp-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
  .icp-card-title { font-size: 15px; font-weight: 700; color: var(--accent2); margin-bottom: 8px; }
  .icp-card-desc { font-size: 13px; color: var(--muted); margin-bottom: 16px; line-height: 1.5; }
  .icp-metric { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .icp-metric:last-child { border-bottom: none; }
  .icp-metric-label { font-size: 12px; color: var(--muted); }
  .icp-metric-value { font-size: 16px; font-weight: 700; }
  .icp-metric-value.highlight { color: var(--green); }
  .icp-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
  .icp-tag { font-size: 11px; background: var(--surface); border: 1px solid var(--border); padding: 2px 8px; border-radius: 10px; color: var(--muted); }

  /* Upload overlay */
  .upload-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 100; align-items: center; justify-content: center; }
  .upload-overlay.active { display: flex; }
  .upload-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 32px; max-width: 440px; width: 90%; text-align: center; }
  .upload-modal h2 { font-size: 20px; margin-bottom: 8px; }
  .upload-modal p { color: var(--muted); font-size: 14px; margin-bottom: 24px; line-height: 1.6; }
  .upload-drop { border: 2px dashed var(--border); border-radius: 12px; padding: 32px; cursor: pointer; transition: border-color .2s; }
  .upload-drop:hover { border-color: var(--accent); }
  .upload-drop .drop-icon { font-size: 36px; margin-bottom: 12px; }
  .upload-progress { margin-top: 16px; display: none; }
  .progress-bar { height: 4px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 8px; }
  .progress-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width .3s; }
  .upload-result { margin-top: 16px; padding: 16px; background: var(--surface2); border-radius: 10px; text-align: left; display: none; }
  .upload-result-row { display: flex; justify-content: space-between; font-size: 14px; padding: 4px 0; }
  .close-modal { margin-top: 20px; background: transparent; border: 1px solid var(--border); color: var(--text); padding: 8px 24px; border-radius: 8px; cursor: pointer; }

  /* Admin overlay */
  .admin-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.7); z-index: 150; align-items: center; justify-content: center; }
  .admin-overlay.active { display: flex; }
  .admin-modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; max-width: 560px; width: 90%; max-height: 80vh; overflow-y: auto; }
  .user-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .user-row:last-child { border-bottom: none; }
  .user-status { font-size: 11px; padding: 2px 8px; border-radius: 10px; }
  .status-approved { background: rgba(52,211,153,.15); color: var(--green); }
  .status-pending { background: rgba(251,191,36,.15); color: var(--yellow); }
  .status-admin { background: rgba(107,99,255,.2); color: var(--accent2); }

  /* Column filter dropdown */
  .col-filter-btn { background: none; border: none; cursor: pointer; font-size: 10px; color: var(--muted); padding: 0 2px; vertical-align: middle; transition: color .15s; }
  .col-filter-btn:hover, .col-filter-btn.active { color: var(--accent2); }
  .col-filter-btn.active { color: var(--green); }
  .col-filter-dropdown { display: none; position: fixed; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 10px; width: 230px; z-index: 200; box-shadow: 0 6px 24px rgba(0,0,0,.5); font-size: 13px; }
  .col-filter-dropdown.open { display: block; }
  .col-filter-search { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; color: var(--text); font-size: 12px; font-family: var(--font); margin-bottom: 6px; }
  .col-filter-search:focus { outline: none; border-color: var(--accent); }
  .col-filter-mode { display: flex; gap: 4px; margin-bottom: 8px; }
  .col-filter-mode button { flex: 1; padding: 4px 0; border-radius: 5px; border: 1px solid var(--border); background: transparent; color: var(--muted); font-size: 11px; cursor: pointer; }
  .col-filter-mode button.active { background: var(--accent); border-color: var(--accent); color: white; }
  .col-filter-list { max-height: 180px; overflow-y: auto; margin-bottom: 8px; }
  .col-filter-list::-webkit-scrollbar { width: 4px; }
  .col-filter-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
  .col-filter-item { display: flex; align-items: center; gap: 8px; padding: 4px 2px; cursor: pointer; border-radius: 4px; }
  .col-filter-item:hover { background: rgba(255,255,255,.04); }
  .col-filter-item input[type=checkbox] { accent-color: var(--accent); width: 13px; height: 13px; flex-shrink: 0; }
  .col-filter-item label { font-size: 12px; color: var(--text); cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 175px; }
  .col-filter-select-all { font-size: 11px; color: var(--accent2); cursor: pointer; margin-bottom: 4px; display: block; }
  .col-filter-actions { display: flex; gap: 6px; margin-top: 4px; }
  .col-filter-actions button { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-size: 12px; cursor: pointer; background: transparent; color: var(--text); }
  .col-filter-actions button.apply { background: var(--accent); border-color: var(--accent); color: white; font-weight: 600; }
  /* Date filter */
  .date-filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-bottom: 8px; }
  .date-filter-grid label { font-size: 11px; color: var(--muted); display: block; margin-bottom: 3px; }
  .date-filter-grid select { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 5px 8px; color: var(--text); font-size: 12px; font-family: var(--font); }

  /* Threshold popover */
  .threshold-wrap { position: relative; display: inline-flex; align-items: center; }
  .threshold-popover { display: none; position: absolute; bottom: calc(100% + 8px); right: 0; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; width: 220px; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,.4); }
  .threshold-popover.open { display: block; }
  .threshold-popover label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 8px; line-height: 1.4; }
  .threshold-popover input[type=number] { width: 70px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 5px 8px; color: var(--text); font-size: 13px; font-family: var(--font); }
  /* Discovery proposal banner */
  .proposal-banner { display: none; background: rgba(107,99,255,.08); border: 1px solid var(--accent); border-radius: 10px; padding: 12px 16px; margin: 8px 12px; font-size: 13px; }
  .proposal-banner.active { display: block; }
  .proposal-banner .proposal-title { font-weight: 600; color: var(--accent2); margin-bottom: 8px; }
  .proposal-item { display: flex; align-items: center; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 12px; color: var(--muted); }
  .proposal-item:last-child { border-bottom: none; }
  .proposal-actions { display: flex; gap: 6px; margin-top: 10px; }

  /* Spinner */
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Mobile */
  @media (max-width: 768px) {
    .app { flex-direction: column; }
    .chat-panel { width: 100%; height: 45vh; border-right: none; border-bottom: 1px solid var(--border); }
    .stats-bar { gap: 12px; }
    .stat-value { font-size: 15px; }
    .header { padding: 10px 14px; flex-wrap: wrap; gap: 8px; }
  }
</style>
</head>
<body>

<!-- AUTH SCREEN -->
<div class="auth-screen active" id="auth-screen">
  <div class="auth-box">
    <div style="text-align:center;margin-bottom:20px">
      <img src="/static/logo.png" onerror="this.style.display='none'" style="height:56px;width:auto" alt="">
    </div>
    <div style="text-align:center;margin-bottom:4px">
      <span style="font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600">Exec Functions</span>
    </div>
    <div class="auth-logo" style="text-align:center">Network<span>Scanner</span></div>
    <div class="auth-sub" style="text-align:center">B2B Network Intelligence</div>

    <div id="auth-error-banner" style="display:none;background:rgba(248,113,113,.1);border:1px solid var(--red);border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:13px;color:var(--red)"></div>
    <div id="auth-pending-banner" style="display:none;background:rgba(251,191,36,.1);border:1px solid var(--yellow);border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:var(--yellow);line-height:1.5"></div>

    <a href="/api/auth/google/login" class="google-btn">
      <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-3.59-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
      Sign in with Google
    </a>

    <div class="auth-divider">‚Äî or ‚Äî</div>
    <div class="guest-link">Just exploring? <a onclick="enterGuestMode()">Continue as guest</a> ‚Äî upload your own CSV, nothing stored on our servers.</div>
  </div>
</div>

<!-- UPLOAD OVERLAY -->
<div class="upload-overlay" id="upload-overlay">
  <div class="upload-modal">
    <h2 id="upload-title">Upload LinkedIn Connections</h2>
    <p id="upload-desc">Export from LinkedIn ‚Üí Settings ‚Üí Data Privacy ‚Üí Get a copy of your data ‚Üí Connections. Upload the CSV here.</p>
    <div class="upload-drop" id="upload-drop" onclick="document.getElementById('file-input').click()">
      <div class="drop-icon">üìÅ</div>
      <p style="font-weight:600;margin-bottom:4px">Click to select CSV file</p>
      <p style="font-size:12px;color:var(--muted)">or drag and drop</p>
    </div>
    <input type="file" id="file-input" accept=".csv">
    <div class="upload-progress" id="upload-progress">
      <p style="font-size:13px;color:var(--muted)" id="upload-status">Uploading...</p>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>
    <div class="upload-result" id="upload-result"></div>
    <button class="close-modal" onclick="closeUpload()">Close</button>
  </div>
</div>

<!-- ADMIN OVERLAY -->
<div class="admin-overlay" id="admin-overlay">
  <div class="admin-modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h2 style="font-size:18px;font-weight:700">üë• User Management</h2>
      <button class="action-btn" onclick="closeAdmin()">‚úï Close</button>
    </div>
    <div id="admin-users-list"><div style="color:var(--muted)">Loading...</div></div>
  </div>
</div>

<!-- HEADER -->
<div class="header" id="main-header" style="display:none">
  <div class="logo">
    <img class="logo-img" id="logo-img" src="/static/logo.png" onerror="this.style.display='none'" alt="">
    <div class="logo-text">Network<span>Scanner</span></div>
  </div>
  <div class="stats-bar" id="stats-bar" style="display:none">
    <div class="stat"><div class="stat-value" id="stat-total">‚Äì</div><div class="stat-label">Contacts</div></div>
    <div class="stat"><div class="stat-value" id="stat-companies">‚Äì</div><div class="stat-label">Companies</div></div>
    <div class="stat"><div class="stat-value" id="stat-enriched">‚Äì</div><div class="stat-label">Enriched</div></div>
  </div>
  <div class="header-right">
    <span class="mode-badge" id="mode-badge"></span>
    <span class="user-email" id="user-email-display"></span>
    <button class="header-btn primary" onclick="openUpload()">‚¨Ü Upload CSV</button>
    <button class="header-btn" id="admin-btn" onclick="openAdmin()" style="display:none">‚öô Users</button>
    <button class="header-btn" onclick="doLogout()">Log out</button>
  </div>
</div>

<!-- MAIN APP -->
<div class="app" id="main-app" style="display:none">
  <div class="chat-panel">
    <div class="chat-messages" id="chat-messages">
      <div class="msg assistant">
        <div class="msg-bubble">
          üëã Hi! I'm your Network Scanner. Ask me anything like:<br><br>
          ‚Ä¢ <em>"Find heads of sales at SaaS companies"</em><br>
          ‚Ä¢ <em>"Show VPs at fintech firms in Germany"</em><br>
          ‚Ä¢ <em>"Compare 3 ICPs: CMOs at enterprise, AI founders, heads of product"</em>
        </div>
      </div>
    </div>
    <div class="chat-input-area">
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="search" onclick="setMode('search')">üîç Search</button>
        <button class="mode-tab" data-mode="icp" onclick="setMode('icp')">üéØ ICP</button>
        <button class="mode-tab" data-mode="discovery" onclick="setMode('discovery')">üî≠ Discovery</button>
      </div>
      <div class="input-row">
        <textarea class="chat-input" id="chat-input" rows="2" placeholder='e.g. "Find heads of sales at SaaS companies"' onkeydown="handleKey(event)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>

  <div class="results-panel">
    <div class="results-header">
      <div>
        <div class="results-title" id="results-title">Results</div>
        <div class="results-count" id="results-count">Run a search to see contacts</div>
      </div>
      <div class="results-actions">
        <span class="selected-count" id="selected-count"></span>
        <div class="threshold-wrap" id="threshold-wrap" style="display:none">
          <button class="action-btn" id="enrich-btn" onclick="requestEnrich()" disabled>‚ú® Enrich</button>
          <button class="action-btn" style="padding:6px 8px;margin-left:2px" onclick="toggleThresholdPopover(event)" title="Auto-enrich settings">‚öô</button>
          <div class="threshold-popover" id="threshold-popover">
            <label>Auto-enrich ICP contacts if fewer than <strong id="threshold-display">50</strong> are unenriched.<br><span style="font-size:11px">Set to 0 to always ask.</span></label>
            <input type="number" id="threshold-input" min="0" max="500" value="50" oninput="updateThreshold(this.value)">
          </div>
        </div>
        <button class="action-btn primary" id="export-btn" onclick="exportCSV()" disabled>‚¨á Export CSV</button>
      </div>
    </div>
    <div class="confirm-banner" id="confirm-banner">
      <p id="confirm-text"></p>
      <div class="confirm-actions">
        <button class="action-btn primary" onclick="confirmEnrich()">Yes, enrich</button>
        <button class="action-btn" onclick="cancelEnrich()">Cancel</button>
      </div>
    </div>
    <div class="preview-notice" id="preview-notice"></div>
    <div class="proposal-banner" id="proposal-banner">
      <div class="proposal-title">üî≠ Discovery wants to run searches</div>
      <div id="proposal-list"></div>
      <div class="proposal-actions">
        <button class="action-btn primary" onclick="runProposedSearches()">Run searches</button>
        <button class="action-btn" onclick="skipProposedSearches()">Skip</button>
      </div>
    </div>
    <div class="guest-notice" id="guest-notice">‚ö° Guest mode ‚Äî results are not saved. <a href="#" onclick="showAuthScreen()" style="color:var(--yellow)">Log in</a> to access your stored contacts.</div>
    <div id="results-body" style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
      <div class="empty-state">
        <div class="icon">üï∏Ô∏è</div>
        <h3>Your network awaits</h3>
        <p>Upload your LinkedIn CSV and start a conversation to discover your best connections.</p>
      </div>
    </div>
  </div>
</div>

<script>
const API = '';
let currentMode = 'search';
let conversationHistory = [];
let currentResults = [];
let checkedUrls = new Set();
let currentFilters = null;
let pendingEnrichUrls = [];
let isGuest = false;
let guestContacts = [];
let isAdmin = false;
let autoEnrichThreshold = parseInt(localStorage.getItem('autoEnrichThreshold') || '50', 10);
let pendingProposedSearches = [];
let pendingProposedDbSearch = null;
let pendingProposedMessage = '';  // the original message to re-send with proposals

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleOAuthRedirectParams() {
  const params = new URLSearchParams(window.location.search);
  const error = params.get('error');
  const pending = params.get('pending');
  if (error) {
    const el = document.getElementById('auth-error-banner');
    el.style.display = 'block';
    el.textContent = decodeURIComponent(error);
    window.history.replaceState({}, '', '/');
  } else if (pending) {
    const el = document.getElementById('auth-pending-banner');
    el.style.display = 'block';
    el.innerHTML = '‚è≥ <strong>Access pending approval.</strong> Your account has been created. An admin will review and approve your access shortly.';
    window.history.replaceState({}, '', '/');
  }
}

async function doLogout() {
  await fetch('/api/auth/logout', { method:'POST', credentials:'include' });
  location.reload();
}

function showAuthScreen() {
  document.getElementById('auth-screen').classList.add('active');
  document.getElementById('main-header').style.display = 'none';
  document.getElementById('main-app').style.display = 'none';
}

async function checkExistingSession() {
  try {
    const r = await fetch('/api/auth/me', { credentials:'include' });
    const d = await r.json();
    if (d.authenticated) { enterPrivateMode(d.email, d.is_admin); return true; }
  } catch(e) {}
  return false;
}

function enterPrivateMode(email, admin) {
  isGuest = false; isAdmin = !!admin;
  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('main-header').style.display = 'flex';
  document.getElementById('main-app').style.display = 'flex';
  document.getElementById('stats-bar').style.display = 'flex';
  document.getElementById('mode-badge').textContent = 'üîí Private';
  document.getElementById('mode-badge').className = 'mode-badge private';
  document.getElementById('user-email-display').textContent = email;
  document.getElementById('threshold-wrap').style.display = 'inline-flex';
  document.getElementById('threshold-input').value = autoEnrichThreshold;
  document.getElementById('threshold-display').textContent = autoEnrichThreshold;
  document.getElementById('enrich-btn').disabled = true;
  document.getElementById('guest-notice').style.display = 'none';
  if (admin) document.getElementById('admin-btn').style.display = '';
  loadStats();
  setInterval(loadStats, 30000);
}

function enterGuestMode() {
  isGuest = true; isAdmin = false;
  document.getElementById('auth-screen').classList.remove('active');
  document.getElementById('main-header').style.display = 'flex';
  document.getElementById('main-app').style.display = 'flex';
  document.getElementById('stats-bar').style.display = 'none';
  document.getElementById('mode-badge').textContent = 'üë§ Guest';
  document.getElementById('mode-badge').className = 'mode-badge guest';
  document.getElementById('user-email-display').textContent = 'Guest';
  document.getElementById('enrich-btn').style.display = 'none';
  document.getElementById('guest-notice').style.display = 'block';
  document.getElementById('upload-title').textContent = 'Upload Your LinkedIn Connections';
  document.getElementById('upload-desc').textContent = 'Your data stays in your browser only ‚Äî nothing is stored on our servers.';
  appendMessage('assistant', 'üë§ **Guest mode** ‚Äî upload your LinkedIn CSV to get started. Your data stays in your browser and is never stored on our servers.');
}

window.addEventListener('load', () => { handleOAuthRedirectParams(); checkExistingSession(); });

// ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStats() {
  if (isGuest) return;
  try {
    const r = await fetch('/api/stats', { credentials:'include' });
    if (r.status === 401) { showAuthScreen(); return; }
    const d = await r.json();
    document.getElementById('stat-total').textContent = d.total.toLocaleString();
    document.getElementById('stat-companies').textContent = d.companies.toLocaleString();
    document.getElementById('stat-enriched').textContent = d.enriched.toLocaleString();
  } catch(e) {}
}

// ‚îÄ‚îÄ Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode===mode));
  const ph = {
    search: 'e.g. "Find heads of sales at SaaS companies"',
    icp: 'Describe 2-3 ICPs: "ICP1: CMOs at enterprise, ICP2: AI founders, ICP3: VPs of Product"',
    discovery: 'Ask anything ‚Äî I\'ll search your network, the web, and think out loud with you...'
  };
  document.getElementById('chat-input').placeholder = ph[mode];
}

// ‚îÄ‚îÄ Chat ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleKey(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg) return;
  input.value = '';
  appendMessage('user', msg);
  const btn = document.getElementById('send-btn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>';
  const typingEl = appendMessage('assistant', '<div class="spinner"></div>', true);
  try {
    const body = {
      message: msg,
      history: conversationHistory,
      mode: currentMode,
      auto_enrich_threshold: autoEnrichThreshold,
    };
    if (isGuest) body.guest_data = guestContacts;
    const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
    const data = await res.json();
    conversationHistory.push({role:'user', content:msg});
    conversationHistory.push({role:'assistant', content:data.message});
    if (conversationHistory.length > 20) conversationHistory = conversationHistory.slice(-20);
    typingEl.querySelector('.msg-bubble').innerHTML = formatMessage(data.message);
    typingEl.querySelector('.msg-meta').textContent = new Date().toLocaleTimeString();

    if (data.type === 'search') {
      currentResults = data.results || [];
      currentFilters = data.filters;
      checkedUrls = new Set(currentResults.map(r => r.linkedin_url));
      renderTable(currentResults, data.total);
      document.getElementById('export-btn').disabled = currentResults.length === 0;
      document.getElementById('enrich-btn').disabled = isGuest || currentResults.length === 0;

    } else if (data.type === 'icp_comparison') {
      renderICPComparison(data.icp_results);

    } else if (data.type === 'icp_enrich_needed') {
      // Show inline confirm buttons in chat
      showIcpEnrichConfirm(data.unenriched_count, data.icp_descriptions, typingEl);

    } else if (data.type === 'discovery') {
      // Show web results if any were run
      if (data.db_results && data.db_results.length > 0) {
        currentResults = data.db_results;
        checkedUrls = new Set(currentResults.map(r => r.linkedin_url));
        renderTable(currentResults, data.total);
        document.getElementById('export-btn').disabled = false;
      }
      // Surface proposed searches for user confirmation
      if (data.has_proposals) {
        showProposalBanner(data.proposed_searches, data.proposed_db_search, msg);
      } else {
        hideProposalBanner();
      }
    }
  } catch(e) { typingEl.querySelector('.msg-bubble').textContent = '‚ùå Error. Please try again.'; }
  btn.disabled = false; btn.innerHTML = '‚û§';
}

function appendMessage(role, content, isTyping=false) {
  const c = document.getElementById('chat-messages');
  const el = document.createElement('div');
  el.className = `msg ${role}`;
  el.innerHTML = `<div class="msg-bubble">${isTyping ? content : formatMessage(content)}</div><div class="msg-meta">${isTyping ? '' : new Date().toLocaleTimeString()}</div>`;
  c.appendChild(el); c.scrollTop = c.scrollHeight; return el;
}

function formatMessage(t) {
  return String(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\n/g,'<br>');
}

// ‚îÄ‚îÄ Threshold popover ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleThresholdPopover(e) {
  e.stopPropagation();
  document.getElementById('threshold-popover').classList.toggle('open');
}
document.addEventListener('click', () => document.getElementById('threshold-popover')?.classList.remove('open'));

function updateThreshold(val) {
  autoEnrichThreshold = parseInt(val, 10) || 0;
  localStorage.setItem('autoEnrichThreshold', autoEnrichThreshold);
  document.getElementById('threshold-display').textContent = autoEnrichThreshold;
}

// ‚îÄ‚îÄ ICP enrich confirmation (inline in chat) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showIcpEnrichConfirm(unenrichedCount, icpDescriptions, msgEl) {
  const bubble = msgEl.querySelector('.msg-bubble');
  bubble.innerHTML += `
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="action-btn primary" style="font-size:12px" onclick="confirmIcpEnrich('${escHtml(icpDescriptions).replace(/'/g,"\\'")}', this)">‚ú® Yes, enrich ${unenrichedCount} contacts</button>
      <button class="action-btn" style="font-size:12px" onclick="skipIcpEnrich('${escHtml(icpDescriptions).replace(/'/g,"\\'")}', this)">Skip, show estimate anyway</button>
    </div>`;
}

async function confirmIcpEnrich(icpDescriptions, btn) {
  btn.closest('div').innerHTML = '<span style="color:var(--muted);font-size:12px">‚è≥ Enriching contacts, then scoring ICPs‚Ä¶</span>';
  const body = {
    message: icpDescriptions,
    history: conversationHistory,
    mode: 'icp',
    auto_enrich_threshold: autoEnrichThreshold,
    icp_confirmed_enrich: true,
    icp_descriptions: icpDescriptions,
  };
  const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
  const data = await res.json();
  if (data.type === 'icp_comparison') renderICPComparison(data.icp_results);
  appendMessage('assistant', data.message);
}

async function skipIcpEnrich(icpDescriptions, btn) {
  btn.closest('div').remove();
  const body = {
    message: icpDescriptions,
    history: conversationHistory,
    mode: 'icp',
    auto_enrich_threshold: 999999,  // force skip enrichment
    icp_confirmed_enrich: false,
    icp_descriptions: icpDescriptions,
  };
  const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
  const data = await res.json();
  if (data.type === 'icp_comparison') renderICPComparison(data.icp_results);
  appendMessage('assistant', data.message + '\n\n*Note: results based on unenriched data ‚Äî consider enriching for better accuracy.*');
}

// ‚îÄ‚îÄ Discovery proposal banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showProposalBanner(searches, dbSearch, originalMsg) {
  pendingProposedSearches = searches || [];
  pendingProposedDbSearch = dbSearch || null;
  pendingProposedMessage = originalMsg;
  const banner = document.getElementById('proposal-banner');
  const list = document.getElementById('proposal-list');
  let html = '';
  searches.forEach(q => {
    html += `<div class="proposal-item"><span>üåê Web: <em>${escHtml(q)}</em></span></div>`;
  });
  if (dbSearch) {
    html += `<div class="proposal-item"><span>üóÑ DB: <em>${escHtml(dbSearch)}</em></span></div>`;
  }
  list.innerHTML = html;
  banner.classList.add('active');
}

function hideProposalBanner() {
  document.getElementById('proposal-banner').classList.remove('active');
  pendingProposedSearches = [];
  pendingProposedDbSearch = null;
}

async function runProposedSearches() {
  hideProposalBanner();
  const btn = document.getElementById('send-btn');
  btn.disabled = true; btn.innerHTML = '<div class="spinner"></div>';
  const typingEl = appendMessage('assistant', '<div class="spinner"></div>', true);
  try {
    const body = {
      message: pendingProposedMessage,
      history: conversationHistory,
      mode: 'discovery',
      proposed_searches: pendingProposedSearches,
      proposed_db_search: pendingProposedDbSearch || '',
    };
    const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body), credentials:'include' });
    const data = await res.json();
    conversationHistory.push({role:'assistant', content: data.message});
    typingEl.querySelector('.msg-bubble').innerHTML = formatMessage(data.message);
    typingEl.querySelector('.msg-meta').textContent = new Date().toLocaleTimeString();
    if (data.db_results && data.db_results.length > 0) {
      currentResults = data.db_results;
      checkedUrls = new Set(currentResults.map(r => r.linkedin_url));
      renderTable(currentResults, data.total);
      document.getElementById('export-btn').disabled = false;
    }
    if (data.has_proposals) showProposalBanner(data.proposed_searches, data.proposed_db_search, pendingProposedMessage);
  } catch(e) { typingEl.querySelector('.msg-bubble').textContent = '‚ùå Search failed. Please try again.'; }
  btn.disabled = false; btn.innerHTML = '‚û§';
}

function skipProposedSearches() {
  hideProposalBanner();
  appendMessage('assistant', 'OK, skipped the web searches. Let me know if you\'d like to dig deeper on anything.');
}

// ‚îÄ‚îÄ Table state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let tableSort = { col: null, dir: 1 };
// colFilters: map of col ‚Üí { mode: 'contains'|'notcontains', values: Set of selected values }
// For connected_on: { year: '2023'|'', month: '03'|'' }
let colFilters = {};
let visibleResults = [];
let openFilterCol = null;  // which dropdown is open

// ‚îÄ‚îÄ Filter dropdown engine ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FILTERABLE_COLS = ['last_name','position','company','location','enriched_industry','connected_on'];
const DATE_COL = 'connected_on';

function getColValues(col) {
  // Unique non-empty values for a column across full result set
  const key = col === 'enriched_industry' ? 'enriched_industry' : col;
  const vals = currentResults.map(r => (r[key]||'').trim()).filter(Boolean);
  return [...new Set(vals)].sort((a,b) => a.localeCompare(b));
}

function getDateParts() {
  const years = new Set(), months = new Set();
  currentResults.forEach(r => {
    const d = r.connected_on || '';
    const m = d.match(/(\d{4})-(\d{2})/);
    if (m) { years.add(m[1]); months.add(m[2]); }
  });
  return { years: [...years].sort().reverse(), months: [...months].sort() };
}

function isColFiltered(col) {
  const f = colFilters[col];
  if (!f) return false;
  if (col === DATE_COL) return !!(f.year || f.month);
  return f.values && f.values.size > 0;
}

function applyTableView() {
  let rows = currentResults.filter(r => {
    for (const col of FILTERABLE_COLS) {
      const f = colFilters[col];
      if (!f) continue;
      if (col === DATE_COL) {
        if (!f.year && !f.month) continue;
        const d = r.connected_on || '';
        const ym = d.match(/(\d{4})-(\d{2})/);
        if (f.year && (!ym || ym[1] !== f.year)) return false;
        if (f.month && (!ym || ym[2] !== f.month)) return false;
      } else {
        if (!f.values || f.values.size === 0) continue;
        const val = (r[col] || '').trim();
        const matched = f.values.has(val);
        if (f.mode === 'notcontains' && matched) return false;
        if (f.mode === 'contains' && !matched) return false;
      }
    }
    return true;
  });
  if (tableSort.col) {
    rows = [...rows].sort((a, b) => {
      let av = a[tableSort.col] ?? '', bv = b[tableSort.col] ?? '';
      if (tableSort.col === '_score') { av = parseFloat(av)||0; bv = parseFloat(bv)||0; }
      else { av = String(av).toLowerCase(); bv = String(bv).toLowerCase(); }
      return av < bv ? -tableSort.dir : av > bv ? tableSort.dir : 0;
    });
  }
  visibleResults = rows;
  return rows;
}

function renderTable(results, total) {
  document.getElementById('results-title').textContent = 'Search Results';
  tableSort = { col: null, dir: 1 };
  colFilters = {};
  closeFilterDropdown();
  if (results.length === 0) {
    document.getElementById('preview-notice').style.display='none';
    document.getElementById('results-count').textContent = `${total.toLocaleString()} contacts matched`;
    document.getElementById('results-body').innerHTML = `<div class="empty-state"><div class="icon">üîç</div><h3>No matches found</h3><p>Try broader keywords or a different search.</p></div>`;
    return;
  }
  renderTableBody();
}

function renderTableBody() {
  const rows = applyTableView();
  const total = currentResults.length;
  const shown = rows.length;
  const hasFilters = FILTERABLE_COLS.some(c => isColFiltered(c));
  const preview = document.getElementById('preview-notice');
  document.getElementById('results-count').textContent = `${total.toLocaleString()} contacts matched`;
  if (shown < total || hasFilters) {
    preview.style.display='block';
    preview.textContent = `Showing ${shown.toLocaleString()} of ${total.toLocaleString()}${hasFilters ? ' (filters active)' : ''}. Export respects checkboxes.`;
  } else { preview.style.display='none'; }

  const sortArrow = col => tableSort.col !== col
    ? '<span style="opacity:.25;font-size:9px">‚áÖ</span>'
    : (tableSort.dir === 1 ? ' ‚Üë' : ' ‚Üì');
  const filterBtn = (col) => {
    const active = isColFiltered(col);
    return `<button class="col-filter-btn ${active?'active':''}" onclick="openFilterDropdown(event,'${col}')" title="Filter">${active?'‚óè':'‚ñæ'}</button>`;
  };
  const sortTh = (col, label, filterable=false) =>
    `<th style="cursor:pointer;user-select:none;white-space:nowrap" onclick="sortTable('${col}')">${label}${sortArrow(col)}${filterable ? ' '+filterBtn(col) : ''}</th>`;

  document.getElementById('results-body').innerHTML = `
    <div class="table-wrapper"><table>
      <thead><tr>
        <th class="check-col"><input type="checkbox" class="row-check" id="check-all" checked onchange="toggleAll(this.checked)"></th>
        ${sortTh('_score','Match')}
        ${sortTh('last_name','Name',true)}
        ${sortTh('position','Position',true)}
        ${sortTh('company','Company',true)}
        ${sortTh('location','Location',true)}
        ${sortTh('enriched_industry','Industry',true)}
        ${sortTh('connected_on','Connected',true)}
        <th>LinkedIn</th>
      </tr></thead>
      <tbody>${rows.map(renderRow).join('')}</tbody>
    </table></div>`;

  // Re-attach the shared dropdown to body (not inside table to avoid clipping)
  updateSelectedCount();
  updateCheckAll();
}

function sortTable(col) {
  if (tableSort.col === col) { tableSort.dir *= -1; }
  else { tableSort.col = col; tableSort.dir = col === '_score' ? -1 : 1; }
  renderTableBody();
}

// ‚îÄ‚îÄ Filter dropdown open/close ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFilterDropdown(e, col) {
  e.stopPropagation();
  // If clicking the same open dropdown, close it
  if (openFilterCol === col) { closeFilterDropdown(); return; }
  openFilterCol = col;

  // Remove existing dropdown
  document.getElementById('col-filter-dropdown')?.remove();

  const dropdown = document.createElement('div');
  dropdown.id = 'col-filter-dropdown';
  dropdown.className = 'col-filter-dropdown open';
  dropdown.onclick = e2 => e2.stopPropagation();

  if (col === DATE_COL) {
    buildDateFilter(dropdown, col);
  } else {
    buildTextFilter(dropdown, col);
  }

  document.body.appendChild(dropdown);

  // Position below the clicked button
  const rect = e.target.getBoundingClientRect();
  dropdown.style.top = (rect.bottom + 4) + 'px';
  // Anchor to right of button, but keep within viewport
  let left = rect.left;
  if (left + 230 > window.innerWidth) left = window.innerWidth - 240;
  dropdown.style.left = left + 'px';
}

function closeFilterDropdown() {
  document.getElementById('col-filter-dropdown')?.remove();
  openFilterCol = null;
}
document.addEventListener('click', closeFilterDropdown);

// ‚îÄ‚îÄ Text filter builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTextFilter(dropdown, col) {
  const f = colFilters[col] || { mode: 'contains', values: new Set() };
  const allVals = getColValues(col);
  let searchTerm = '';

  function getCheckedVals() {
    return new Set([...dropdown.querySelectorAll('.cfv:checked')].map(cb => cb.value));
  }

  function renderList() {
    const term = searchTerm.toLowerCase();
    const filtered = allVals.filter(v => v.toLowerCase().includes(term));
    const listEl = dropdown.querySelector('.col-filter-list');
    listEl.innerHTML = filtered.length === 0
      ? `<div style="color:var(--muted);font-size:12px;padding:8px 0">No matches</div>`
      : filtered.map(v => {
          const chk = f.values.has(v) ? 'checked' : '';
          const id = 'cfv_' + Math.random().toString(36).slice(2);
          return `<div class="col-filter-item"><input type="checkbox" class="cfv" id="${id}" value="${escHtml(v)}" ${chk}><label for="${id}">${escHtml(v)||'(blank)'}</label></div>`;
        }).join('');
  }

  dropdown.innerHTML = `
    <div class="col-filter-mode">
      <button class="${f.mode==='contains'?'active':''}" onclick="setFilterMode(this,'contains')">Contains</button>
      <button class="${f.mode==='notcontains'?'active':''}" onclick="setFilterMode(this,'notcontains')">Does not contain</button>
    </div>
    <input class="col-filter-search" placeholder="Search values‚Ä¶" oninput="cfSearch(this)">
    <span class="col-filter-select-all" onclick="cfSelectAll(this)">Select all / None</span>
    <div class="col-filter-list"></div>
    <div class="col-filter-actions">
      <button onclick="clearColFilter('${col}')">Clear</button>
      <button class="apply" onclick="applyColFilter('${col}')">Apply Filter</button>
    </div>`;

  renderList();

  dropdown._col = col;
  dropdown._getMode = () => dropdown.querySelector('.col-filter-mode .active')?.textContent === 'Does not contain' ? 'notcontains' : 'contains';
  dropdown._getValues = getCheckedVals;
  dropdown._renderList = renderList;
  dropdown._allVals = allVals;

  // Restore current filter
  colFilters[col] = f;
}

function setFilterMode(btn, mode) {
  btn.closest('.col-filter-mode').querySelectorAll('button').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function cfSearch(input) {
  const dd = document.getElementById('col-filter-dropdown');
  if (!dd) return;
  dd._searchTerm = input.value;
  // Re-render list with search
  const term = input.value.toLowerCase();
  const filtered = dd._allVals.filter(v => v.toLowerCase().includes(term));
  const f = colFilters[dd._col] || { values: new Set() };
  dd.querySelector('.col-filter-list').innerHTML = filtered.length === 0
    ? `<div style="color:var(--muted);font-size:12px;padding:8px 0">No matches</div>`
    : filtered.map(v => {
        const chk = f.values.has(v) ? 'checked' : '';
        const id = 'cfv_' + Math.random().toString(36).slice(2);
        return `<div class="col-filter-item"><input type="checkbox" class="cfv" id="${id}" value="${escHtml(v)}" ${chk}><label for="${id}">${escHtml(v)||'(blank)'}</label></div>`;
      }).join('');
}
function cfSelectAll(el) {
  const dd = document.getElementById('col-filter-dropdown');
  const boxes = dd.querySelectorAll('.cfv');
  const allChecked = [...boxes].every(b => b.checked);
  boxes.forEach(b => b.checked = !allChecked);
}
function applyColFilter(col) {
  const dd = document.getElementById('col-filter-dropdown');
  const values = new Set([...dd.querySelectorAll('.cfv:checked')].map(cb => cb.value));
  const mode = dd._getMode();
  colFilters[col] = { mode, values };
  closeFilterDropdown();
  renderTableBody();
}
function clearColFilter(col) {
  delete colFilters[col];
  closeFilterDropdown();
  renderTableBody();
}

// ‚îÄ‚îÄ Date filter builder ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDateFilter(dropdown, col) {
  const f = colFilters[col] || { year: '', month: '' };
  const { years, months } = getDateParts();
  const monthNames = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  const yearOpts = `<option value="">All years</option>` + years.map(y => `<option value="${y}" ${f.year===y?'selected':''}>${y}</option>`).join('');
  const monthOpts = `<option value="">All months</option>` + months.map(m => `<option value="${m}" ${f.month===m?'selected':''}>${monthNames[parseInt(m)]||m}</option>`).join('');

  dropdown.innerHTML = `
    <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.5px">Filter by date connected</div>
    <div class="date-filter-grid">
      <div><label>Year</label><select id="df-year">${yearOpts}</select></div>
      <div><label>Month</label><select id="df-month">${monthOpts}</select></div>
    </div>
    <div class="col-filter-actions">
      <button onclick="clearColFilter('${col}')">Clear</button>
      <button class="apply" onclick="applyDateFilter('${col}')">Apply Filter</button>
    </div>`;
}
function applyDateFilter(col) {
  const year = document.getElementById('df-year')?.value || '';
  const month = document.getElementById('df-month')?.value || '';
  if (!year && !month) { delete colFilters[col]; }
  else { colFilters[col] = { year, month }; }
  closeFilterDropdown();
  renderTableBody();
}

function renderRow(r) {
  const score = r._score || 0;
  const sc = score >= .8 ? 'score-high' : score >= .6 ? 'score-mid' : 'score-low';
  const name = [r.first_name, r.last_name].filter(Boolean).join(' ');
  const enriched = r.enriched_at ? '<span class="enriched-pill">‚úì</span>' : '';
  const loc = r.location ? escHtml(r.location) : '‚Äì';
  const checked = checkedUrls.has(r.linkedin_url);
  const rowId = 'row-' + r.linkedin_url.replace(/[^a-z0-9]/gi,'_');
  const escapedUrl = escHtml(r.linkedin_url);
  return `
    <tr id="${rowId}" class="${checked ? '' : 'deselected'}">
      <td class="check-col"><input type="checkbox" class="row-check" ${checked ? 'checked' : ''} onchange="toggleRow('${escapedUrl}',this.checked)"></td>
      <td><span class="score-badge ${sc}">${Math.round(score*100)}%</span></td>
      <td style="white-space:nowrap;font-weight:500">${escHtml(name)}</td>
      <td style="max-width:180px">${escHtml(r.position||'‚Äì')}${enriched}</td>
      <td style="white-space:nowrap">${escHtml(r.company||'‚Äì')}</td>
      <td style="color:var(--muted);font-size:12px;white-space:nowrap">${loc}</td>
      <td style="color:var(--muted);font-size:12px">${escHtml(r.enriched_industry||'‚Äì')}</td>
      <td style="color:var(--muted);font-size:12px;white-space:nowrap">${r.connected_on||'‚Äì'}</td>
      <td><a class="linkedin-link" href="${escapedUrl}" target="_blank">‚Üó</a></td>
    </tr>`;
}

function toggleRow(url, checked) {
  if (checked) checkedUrls.add(url); else checkedUrls.delete(url);
  const rowId = 'row-' + url.replace(/[^a-z0-9]/gi,'_');
  const row = document.getElementById(rowId);
  if (row) row.className = checked ? '' : 'deselected';
  updateCheckAll();
  updateSelectedCount();
}

function updateCheckAll() {
  const allCheck = document.getElementById('check-all');
  if (!allCheck) return;
  const shown = visibleResults.length ? visibleResults : currentResults;
  const allC = shown.every(r => checkedUrls.has(r.linkedin_url));
  const anyC = shown.some(r => checkedUrls.has(r.linkedin_url));
  allCheck.checked = allC;
  allCheck.indeterminate = !allC && anyC;
}

function toggleAll(checked) {
  const shown = visibleResults.length ? visibleResults : currentResults;
  shown.forEach(r => {
    if (checked) checkedUrls.add(r.linkedin_url); else checkedUrls.delete(r.linkedin_url);
    const rowId = 'row-' + r.linkedin_url.replace(/[^a-z0-9]/gi,'_');
    const row = document.getElementById(rowId);
    if (row) { row.className = checked ? '' : 'deselected'; const cb = row.querySelector('.row-check'); if(cb) cb.checked = checked; }
  });
  updateSelectedCount();
}

function updateSelectedCount() {
  const el = document.getElementById('selected-count');
  const n = currentResults.filter(r => checkedUrls.has(r.linkedin_url)).length;
  const total = currentResults.length;
  if (n < total) { el.style.display='inline'; el.textContent=`${n} of ${total} selected`; }
  else { el.style.display='none'; }
}

function escHtml(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ ICP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderICPComparison(icps) {
  document.getElementById('preview-notice').style.display='none';
  document.getElementById('results-title').textContent='ICP Comparison';
  document.getElementById('results-count').textContent=`${icps.length} profiles compared (quick estimate)`;
  document.getElementById('results-body').innerHTML=`<div class="icp-grid">${icps.map(renderICPCard).join('')}</div>`;
  document.getElementById('export-btn').disabled=true;
  document.getElementById('enrich-btn').disabled=true;
}

function renderICPCard(icp) {
  const cos=(icp.top_companies||[]).slice(0,5).map(c=>`<span class="icp-tag">${escHtml(c)}</span>`).join('');
  const pos=(icp.top_positions||[]).slice(0,5).map(p=>`<span class="icp-tag">${escHtml(p)}</span>`).join('');
  const rate=icp.total_matches>0?Math.round(icp.high_confidence_matches/icp.total_matches*100):0;
  return `<div class="icp-card">
    <div class="icp-card-title">üéØ ${escHtml(icp.icp_name)}</div>
    <div class="icp-card-desc">${escHtml(icp.intent_summary)}</div>
    <div class="icp-metric"><span class="icp-metric-label">Total matches</span><span class="icp-metric-value highlight">${icp.total_matches}</span></div>
    <div class="icp-metric"><span class="icp-metric-label">High confidence</span><span class="icp-metric-value">${icp.high_confidence_matches} <span style="color:var(--muted);font-size:12px">(${rate}%)</span></span></div>
    <div style="margin-top:12px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Top Companies</div>
    <div class="icp-tags">${cos||'‚Äì'}</div>
    <div style="margin-top:12px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Top Roles</div>
    <div class="icp-tags">${pos||'‚Äì'}</div>
    <button class="action-btn" style="margin-top:16px;width:100%" onclick="searchICP('${escHtml(icp.icp_name)}')">Search this ICP ‚Üí</button>
  </div>`;
}
function searchICP(name) { setMode('search'); document.getElementById('chat-input').value=`Find all contacts matching the "${name}" ICP`; sendMessage(); }

// ‚îÄ‚îÄ Enrichment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function requestEnrich() {
  if (!currentResults.length || isGuest) return;
  const unenriched = currentResults.filter(r => !r.enriched_at);
  if (!unenriched.length) { appendMessage('assistant','All contacts already enriched! üéâ'); return; }
  const cos=[...new Set(unenriched.map(r=>r.company).filter(Boolean))];
  pendingEnrichUrls = unenriched.map(r=>r.linkedin_url);
  document.getElementById('confirm-text').textContent=`This will look up ${unenriched.length} contacts across ${cos.length} companies online via Tavily. Proceed?`;
  document.getElementById('confirm-banner').classList.add('active');
}
async function confirmEnrich() {
  document.getElementById('confirm-banner').classList.remove('active');
  if (!pendingEnrichUrls.length) return;
  appendMessage('assistant',`üîç Enriching ${pendingEnrichUrls.length} contacts... this may take a moment.`);
  document.getElementById('enrich-btn').disabled=true;
  try {
    const res=await fetch('/api/enrich',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({linkedin_urls:pendingEnrichUrls}),credentials:'include'});
    const d=await res.json();
    appendMessage('assistant',`‚úÖ ${d.message}`);
    loadStats();
  } catch(e) { appendMessage('assistant','‚ùå Enrichment failed. Please try again.'); }
  document.getElementById('enrich-btn').disabled=false; pendingEnrichUrls=[];
}
function cancelEnrich() { document.getElementById('confirm-banner').classList.remove('active'); pendingEnrichUrls=[]; }

// ‚îÄ‚îÄ Export ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportCSV() {
  // Export from the full result set (respects checkboxes, ignores column filters ‚Äî filters only affect view)
  const toExport = currentResults.filter(r => checkedUrls.has(r.linkedin_url));
  if (!toExport.length) { appendMessage('assistant','No contacts selected. Use checkboxes to select rows for export.'); return; }
  const btn=document.getElementById('export-btn');
  btn.disabled=true; btn.textContent='‚è≥ Exporting...';
  try {
    const res=await fetch('/api/export',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({results:toExport})});
    const blob=await res.blob();
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='network_scan_export.csv';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  } catch(e) { appendMessage('assistant','‚ùå Export failed. Please try again.'); }
  btn.disabled=false; btn.textContent='‚¨á Export CSV';
}

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openUpload() { document.getElementById('upload-overlay').classList.add('active'); }
function closeUpload() {
  document.getElementById('upload-overlay').classList.remove('active');
  document.getElementById('upload-result').style.display='none';
  document.getElementById('upload-progress').style.display='none';
  if (!isGuest) loadStats();
}
document.getElementById('file-input').addEventListener('change', async e => { const f=e.target.files[0]; if(f) await doUpload(f); e.target.value=''; });
const dz=document.getElementById('upload-drop');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.style.borderColor='var(--accent)';});
dz.addEventListener('dragleave',()=>{dz.style.borderColor='var(--border)';});
dz.addEventListener('drop',async e=>{e.preventDefault();dz.style.borderColor='var(--border)';const f=e.dataTransfer.files[0];if(f)await doUpload(f);});

async function doUpload(file) {
  const prog=document.getElementById('upload-progress'), statEl=document.getElementById('upload-status'), fillEl=document.getElementById('progress-fill'), resEl=document.getElementById('upload-result');
  prog.style.display='block'; resEl.style.display='none'; statEl.textContent='Processing...'; fillEl.style.width='30%';
  const fd=new FormData(); fd.append('file',file);
  try {
    fillEl.style.width='70%';
    const endpoint = isGuest ? '/api/guest/upload' : '/api/upload';
    const res=await fetch(endpoint,{method:'POST',body:fd,credentials:'include'});
    fillEl.style.width='100%';
    if(!res.ok){const e=await res.json();statEl.textContent=`Error: ${e.detail}`;return;}
    const d=await res.json(); statEl.textContent='Upload complete!'; resEl.style.display='block';
    if(isGuest){
      guestContacts=d.contacts||[];
      resEl.innerHTML=`<div class="upload-result-row"><span>‚úÖ Contacts loaded (browser only)</span><strong style="color:var(--green)">${d.total_parsed}</strong></div>`;
      appendMessage('assistant',`‚úÖ Loaded **${d.total_parsed}** contacts into your guest session. Start searching!`);
    } else {
      resEl.innerHTML=`
        <div class="upload-result-row"><span>‚úÖ New contacts added</span><strong style="color:var(--green)">${d.added}</strong></div>
        <div class="upload-result-row"><span>üîÑ Existing updated</span><strong>${d.updated}</strong></div>
        <div class="upload-result-row"><span>‚è≠ Skipped</span><strong style="color:var(--muted)">${d.skipped}</strong></div>
        <div class="upload-result-row"><span>üìä Total processed</span><strong>${d.total_parsed}</strong></div>`;
      appendMessage('assistant',`‚úÖ Upload complete! Added **${d.added}** new, updated **${d.updated}** existing contacts.`);
      loadStats();
    }
  } catch(e){statEl.textContent='Upload failed. Please try again.';}
}

// ‚îÄ‚îÄ Admin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function openAdmin() {
  document.getElementById('admin-overlay').classList.add('active');
  const listEl=document.getElementById('admin-users-list');
  try {
    const r=await fetch('/api/admin/users',{credentials:'include'});
    const users=await r.json();
    listEl.innerHTML=users.map(u=>`
      <div class="user-row">
        <div>
          <div style="font-weight:500">${escHtml(u.email)}</div>
          <div style="font-size:11px;color:var(--muted)">Joined ${(u.created_at||'').split('T')[0]||'‚Äì'}</div>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          ${u.is_admin ? '<span class="user-status status-admin">Admin</span>' :
            u.is_approved ? `<span class="user-status status-approved">Approved</span>
             <button class="action-btn" style="padding:4px 10px;font-size:12px;color:var(--red);border-color:var(--red)" onclick="revokeUser(${u.id},this)">Revoke</button>` :
            `<span class="user-status status-pending">Pending</span>
             <button class="action-btn primary" style="padding:4px 10px;font-size:12px" onclick="approveUser(${u.id},this)">Approve</button>`}
        </div>
      </div>`).join('');
  } catch(e){listEl.innerHTML='<div style="color:var(--red)">Failed to load users.</div>';}
}
async function approveUser(id,btn){btn.disabled=true;btn.textContent='...';await fetch(`/api/admin/approve/${id}`,{method:'POST',credentials:'include'});openAdmin();}
async function revokeUser(id,btn){btn.disabled=true;btn.textContent='...';await fetch(`/api/admin/revoke/${id}`,{method:'POST',credentials:'include'});openAdmin();}
function closeAdmin(){document.getElementById('admin-overlay').classList.remove('active');}
</script>
</body>
</html>
